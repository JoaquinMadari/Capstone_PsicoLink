<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Mis Citas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-card>
    <ion-card-header>
      <ion-card-title>Agendar nueva cita</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <form [formGroup]="form">
        <ion-item>
          <ion-label position="stacked">Profesional</ion-label>
          <ion-select formControlName="professional">
            <ion-select-option *ngFor="let p of professionals" [value]="p.id">
              {{ p.full_name || (p.first_name || p.last_name ? (p.first_name + ' ' + p.last_name) : p.username) }}
              • {{ p.specialty_label || p.specialty || '—' }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Fecha</ion-label>
          <ion-datetime 
              displayFormat="DD MMM YYYY" 
              formControlName="date"
              presentation="date"
              (ionChange)="form.controls['date'].markAsDirty(); form.controls['date'].updateValueAndValidity();">
          </ion-datetime>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Hora de inicio</ion-label>
          <ion-select 
              formControlName="time" 
              placeholder="Selecciona una hora"
              (ionChange)="form.controls['time'].markAsDirty(); form.controls['time'].updateValueAndValidity();">
            
            <ion-select-option value="08:00:00">08:00 AM</ion-select-option>
            <ion-select-option value="08:30:00">08:30 AM</ion-select-option>
            <ion-select-option value="09:00:00">09:00 AM</ion-select-option>
            <ion-select-option value="09:30:00">09:30 AM</ion-select-option>
            <ion-select-option value="10:00:00">10:00 AM</ion-select-option>
            <ion-select-option value="10:30:00">10:30 AM</ion-select-option>
            <ion-select-option value="11:00:00">11:00 AM</ion-select-option>
            <ion-select-option value="11:30:00">11:30 AM</ion-select-option>
            <ion-select-option value="12:00:00">12:00 PM</ion-select-option>
            <ion-select-option value="12:30:00">12:30 PM</ion-select-option>
            <ion-select-option value="13:00:00">01:00 PM</ion-select-option>
            <ion-select-option value="13:30:00">01:30 PM</ion-select-option>
            <ion-select-option value="14:00:00">02:00 PM</ion-select-option>
            <ion-select-option value="14:30:00">02:30 PM</ion-select-option>
            <ion-select-option value="15:00:00">03:00 PM</ion-select-option>
            <ion-select-option value="15:30:00">03:30 PM</ion-select-option>
            <ion-select-option value="16:00:00">04:00 PM</ion-select-option>
            <ion-select-option value="16:30:00">04:30 PM</ion-select-option>
            <ion-select-option value="17:00:00">05:00 PM</ion-select-option>
            <ion-select-option value="17:30:00">05:30 PM</ion-select-option>
            <ion-select-option value="18:00:00">06:00 PM</ion-select-option>
            <ion-select-option value="18:30:00">06:30 PM</ion-select-option>
            <ion-select-option value="19:00:00">07:00 PM</ion-select-option>
            <ion-select-option value="19:30:00">07:30 PM</ion-select-option>
            <ion-select-option value="20:00:00">08:00 PM</ion-select-option>
          </ion-select>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Duración (min)</ion-label>
          <ion-input type="number" formControlName="duration"></ion-input>
        </ion-item>

        <!-- Motivo (opcional) -->
        <ion-item>
          <ion-label position="stacked">Motivo</ion-label>
          <ion-input formControlName="reason" maxlength="255" placeholder="(opcional)"></ion-input>
        </ion-item>

        <!-- Modalidad Mixta -->
        <ion-item *ngIf="selectedProfessional?.work_modality === 'Mixta'">
          <ion-label position="stacked">Modalidad</ion-label>
          <ion-select formControlName="modality" interface="popover" placeholder="Elige modalidad">
            <ion-select-option value="Presencial">Presencial</ion-select-option>
            <ion-select-option value="Online">Online</ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Si es fija (Presencial u Online), mostrar como texto deshabilitado -->
        <ion-item *ngIf="selectedProfessional?.work_modality === 'Presencial' || selectedProfessional?.work_modality === 'Online'">
          <ion-label position="stacked">Modalidad</ion-label>
          <ion-input [value]="selectedProfessional?.work_modality" disabled></ion-input>
        </ion-item>

        <ion-button expand="block" class="ion-margin-top" (click)="iniciarPago()" [disabled]="!form.valid">Pagar y Agendar</ion-button>
      </form>
    </ion-card-content>
  </ion-card>

  <ion-card class="mt-8" *ngIf="hasProAndDate">
    <ion-card-header>
      <ion-card-title>
        Disponibilidad ({{ form.value.date | date:'fullDate':'':'es-CL' }})
      </ion-card-title>
      <ion-card-subtitle>
        Paso 1: elige un bloque libre • Paso 2: confirma en “Hora de inicio”
      </ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <div class="slot-legend">
        <ion-chip color="medium" outline>Libre</ion-chip>
        <ion-chip class="legend-pro" outline>Ocupado (profesional)</ion-chip>
        <ion-chip class="legend-patient" outline>Ocupado (tú)</ion-chip>
        <ion-chip class="legend-both" outline>Ocupado (ambos)</ion-chip>
      </div>

      <ion-grid class="slots-grid">
        <ion-row>
          <ion-col size="4" *ngFor="let s of slots;">
            <button type="button"
                    class="slot"
                    [class.busy-pro]="slotStatus[s] === 'pro'"
                    [class.busy-patient]="slotStatus[s] === 'patient'"
                    [class.busy-both]="slotStatus[s] === 'both'"
                    [disabled]="isStartDisabled(s)"
                    (click)="selectTime(s)"
                    [attr.aria-label]="'Seleccionar ' + formatSlotLabel(s)">
              {{ formatSlotLabel(s) }}
            </button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <ion-card class="mt-16">
    <ion-card-header>
      <ion-card-title>Mis próximas citas</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item *ngFor="let a of appointments">
          <ion-label>
            <h2>{{ a.start_datetime | date:'medium':'':'es-CL' }} ({{ a.duration_minutes }} min)</h2>

            <!-- nombre del profesional -->
            <p>
              Profesional:
              {{ a?.professional_detail?.full_name
                || (a?.professional_detail?.first_name || a?.professional_detail?.last_name
                    ? (a?.professional_detail?.first_name + ' ' + a?.professional_detail?.last_name)
                    : a?.professional_detail?.username) }}
            </p>

            <!-- nombre del paciente -->
            <p *ngIf="a?.patient">
              Paciente:
              {{ a?.patient?.full_name
                || (a?.patient?.first_name || a?.patient?.last_name
                    ? (a?.patient?.first_name + ' ' + a?.patient?.last_name)
                    : a?.patient?.username) }}
            </p>

            <p>Status: {{ a.status }}</p>
          </ion-label>

          <ion-button slot="end" color="danger"
                      *ngIf="a.status === 'scheduled'"
                      (click)="cancel(a.id)">
            Cancelar
          </ion-button>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>
</ion-content>

