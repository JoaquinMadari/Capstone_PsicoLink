<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Buscar Profesionales</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <form [formGroup]="searchForm">
    <ion-toolbar>
      <ion-searchbar
        placeholder="Buscar por nombre o especialidad"
        formControlName="query"
        (ionClear)="resetAndLoad()">
      </ion-searchbar>
    </ion-toolbar>

    <ion-item>
      <ion-label position="stacked">Especialidad</ion-label>
      <ion-select formControlName="specialty" interface="popover">
        <ion-select-option value="">Todas las especialidades</ion-select-option>
        <ion-select-option *ngFor="let s of specialties" [value]="s.value">
          {{ s.label }}
        </ion-select-option>
      </ion-select>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Modalidad</ion-label>
      <ion-select formControlName="workModality" placeholder="Selecciona la modalidad">
        <ion-select-option value="">Cualquiera</ion-select-option>
        <ion-select-option *ngFor="let m of workModalities" [value]="m.value">
          {{ m.label }}
        </ion-select-option>
      </ion-select>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Orientación Inclusiva</ion-label>
      <ion-select formControlName="inclusiveOrientation" placeholder="¿Incluye orientación inclusiva?">
        <ion-select-option value="">Cualquiera</ion-select-option>
        <ion-select-option *ngFor="let o of inclusiveOptions" [value]="o.value">
          {{ o.label }}
        </ion-select-option>
      </ion-select>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Experiencia mínima (años)</ion-label>
      <ion-select formControlName="minExperience" placeholder="Cualquier experiencia">
        <ion-select-option [value]="null">Cualquiera</ion-select-option>
        <ion-select-option *ngFor="let year of experienceOptions" [value]="year">
          {{ year }}+
        </ion-select-option>
      </ion-select>
    </ion-item>
  </form>

  <ion-list lines="none">
    <ion-item
      *ngFor="let p of profesionales; trackBy: trackByPro"
      button
      class="ion-margin-vertical ion-padding-vertical custom-item-card"
      (click)="goToProfile(p.id)">

      <ion-icon name="person-circle-outline" slot="start" size="large" color="primary"></ion-icon>

      <ion-label>
        <h2>{{ p.full_name || p.username }}</h2>
        <p>{{ p.specialty_label || p.specialty || '—' }}</p>

        <!-- <p>{{ p.cases_attended ?? 0 }} casos atendidos</p> -->
      </ion-label>

      <ion-button
        slot="end"
        fill="outline"
        size="small"
        [disabled]="!p?.supabase_uid"
        (click)="startChat($event, p?.supabase_uid)">
        Chatear
      </ion-button>

      <ion-button
        slot="end"
        fill="solid"
        size="small"
        (click)="goToAgendarFromList($event, p.id)">
        Agendar
      </ion-button>
    </ion-item>

    <ion-item *ngIf="profesionales.length === 0" lines="full" class="ion-text-center">
      <ion-label class="ion-padding">
        No se encontraron profesionales que coincidan con los filtros.
      </ion-label>
    </ion-item>
  </ion-list>

  <ion-infinite-scroll threshold="100px" (ionInfinite)="loadMore($event)">
    <ion-infinite-scroll-content
      loadingSpinner="lines"
      loadingText="Cargando más profesionales...">
    </ion-infinite-scroll-content>
  </ion-infinite-scroll>
</ion-content>
