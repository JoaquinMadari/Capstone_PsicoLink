<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Mis Citas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <ion-card>
    <ion-card-header>
      <ion-card-title>Listado de Citas</ion-card-title>
    </ion-card-header>
    <ion-card-content>

      <ion-list *ngIf="appointments.length > 0; else emptyState">
        <ion-item *ngFor="let a of appointments">
          <ion-label>
            <h2>{{ a.start_datetime | date:'medium':'':'es-CL' }} ({{ a.duration_minutes }} min)</h2>

            <!-- Mostrar nombre del profesional o paciente -->
            <p>
              Con:
              {{ a.professional_detail?.full_name
                 || (a.professional_detail?.first_name + ' ' + a.professional_detail?.last_name)
                 || a.professional_detail?.email
                 || 'Sin nombre disponible' }}
            </p>

            <p>Estado: {{ a.status === 'cancelled' ? 'Cita cancelada' : a.status }}</p>
          </ion-label>

          <!-- Si la cita tiene enlace Zoom y no terminó -->
          <ion-button
            slot="end"
            color="primary"
            fill="outline"
            *ngIf="a.zoom_join_url && !isPastAppointment(a) && a.status === 'scheduled'"
            (click)="joinMeeting(a.zoom_join_url)">
            Unirse
          </ion-button>

          <!-- Si la cita ya terminó -->
          <ion-button
            slot="end"
            color="medium"
            fill="outline"
            *ngIf="isPastAppointment(a) && a.status !== 'cancelled'"
            disabled="true">
            Reunión finalizada
          </ion-button>

          <!-- Si la cita fue cancelada -->
          <ion-button
            slot="end"
            color="danger"
            fill="outline"
            *ngIf="a.status === 'cancelled'"
            disabled="true">
            Cita cancelada
          </ion-button>

          <!-- Botón Cancelar (solo si está programada y no pasó) -->
          <ion-button
            slot="end"
            color="danger"
            *ngIf="a.status === 'scheduled' && !isPastAppointment(a)"
            (click)="cancel(a.id)">
            Cancelar
          </ion-button>
        </ion-item>
      </ion-list>

      <ng-template #emptyState>
        <p class="ion-text-center">No tienes citas registradas.</p>
      </ng-template>

    </ion-card-content>
  </ion-card>

</ion-content>

