<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button
        [defaultHref]="backHref"
        routerDirection="back"
        (click)="onBackClick()">
      </ion-back-button>
    </ion-buttons>
    <ion-title>Mis Citas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <ion-card>
    <ion-card-header>
      <ion-card-title>Listado de Citas</ion-card-title>
    </ion-card-header>
    <ion-card-content>

      <ion-list *ngIf="appointments.length > 0; else emptyState">

        <ion-item *ngFor="let a of appointments" class="appointment-item">

          <ion-label>

            <h2 class="appointment-datetime">
              {{ a.start_datetime | date:'EEEE d \'de\' MMMM':'':'es-CL' }} — {{ a.start_datetime | date:'hh:mm a' }}
            </h2>
            <p>Duración: {{ a.duration_minutes }} min</p>


            <p class="appointment-with">
              Con:
              {{ a.professional_detail?.full_name
                || (a.professional_detail?.first_name + ' ' + a.professional_detail?.last_name)
                || a.professional_detail?.email
                || 'Sin nombre disponible' }}
            </p>

            <!-- Nuevo estado correcto -->
            <p class="appointment-status">
              Estado:

              <!-- Cancelada -->
              <ng-container *ngIf="a.status === 'cancelled'">
                Cita cancelada
              </ng-container>

              <!-- No cancelada -->
              <ng-container *ngIf="a.status !== 'cancelled'">

                <!-- Finalizada -->
                <span *ngIf="isPastAppointment(a) && a.status === 'completed'; else scheduledState">
                  Cita finalizada
                </span>

                <!-- Programada -->
                <ng-template #scheduledState>
                  Cita programada
                </ng-template>

              </ng-container>
            </p>

          </ion-label>

          <!-- CONTENEDOR RESPONSIVE DE BOTONES -->
          <div class="appointment-actions">

             <!-- Ver / Crear notas del profesional -->
            <ion-button
              *ngIf="role === 'profesional' && isPastAppointment(a) && a.status !== 'cancelled'"
              (click)="goToNotas(a.id)">
              Mis Notas
            </ion-button>



            <ion-button
              color="primary"
              fill="outline"
              *ngIf="a.zoom_join_url && !isPastAppointment(a) && a.status === 'scheduled'"
              (click)="joinMeeting(a.zoom_join_url)">
              Unirse
            </ion-button>

            <ion-button
              color="medium"
              fill="outline"
              *ngIf="isPastAppointment(a) && a.status === 'completed'"
              disabled="true">
              Reunión finalizada
            </ion-button>
            
            <ion-button
              color="warning"
              fill="outline"
              *ngIf="isPastAppointment(a) && a.status === 'scheduled'"
              disabled="true">
              Reunión Sin Cerrar
            </ion-button>

            <ion-button
              color="danger"
              fill="outline"
              *ngIf="a.status === 'cancelled'"
              disabled="true">
              Cita cancelada
            </ion-button>

            <ion-button
              color="danger"
              *ngIf="a.status === 'scheduled' && canBeCancelled(a)"
              (click)="cancel(a.id)">
              Cancelar
            </ion-button>

            <ion-button 
              *ngIf="role === 'profesional' && a.status === 'scheduled' && canBeClosed(a)"
              (click)="onClose(a)" 
              color="success">
              Cerrar Cita
            </ion-button>

          </div>

        </ion-item>

      </ion-list>

      <ng-template #emptyState>
        <p class="ion-text-center">No tienes citas registradas.</p>
      </ng-template>

    </ion-card-content>
  </ion-card>

</ion-content>

